<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Forms & Sheets Manager — Single File (LocalStorage)</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
<style>
  :root{--bg:#f4f7ff;--card:#fff;--accent:#2b6ef6}
  body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial; background:var(--bg); margin:0; color:#0b1220}
  .app{display:grid; grid-template-columns:280px 1fr 560px; gap:16px; min-height:100vh; padding:18px;}
  .panel{background:var(--card); border-radius:12px; padding:14px; box-shadow:0 8px 26px rgba(12,16,30,.06)}
  .sidebar .site-item{padding:10px;border-radius:10px;cursor:pointer}
  .sidebar .site-item:hover{background:#f0f4ff}
  .site-item.active{background:linear-gradient(90deg,var(--accent),#6c5ce7); color:white}
  .field-card{border-radius:10px;padding:12px;background:linear-gradient(180deg,#fff,#fbfbff);border:1px solid #EFF2FF}
  .form-row{display:flex;justify-content:space-between;align-items:center;padding:8px;border-radius:8px;border:1px dashed #eef2ff;margin-top:8px}
  .iframe-wrap{height:72vh;border-radius:8px;overflow:hidden;border:1px solid #eee;background:#fafafa}
  .empty{padding:40px;text-align:center;color:#6b7280}
  .muted{color:#6b7280;font-size:13px}
  .small{font-size:13px}
  @media (max-width:1100px){.app{grid-template-columns:1fr;grid-auto-rows:auto}.app > :nth-child(3){order:3}}
</style>
</head>
<body>

<div class="app">
  <!-- LEFT: Sites -->
  <div class="panel sidebar">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <h5 class="m-0">Sites</h5>
      <div class="small text-muted">Local demo</div>
    </div>

    <div class="mb-2">
      <div class="input-group input-group-sm">
        <input id="new-site-name" class="form-control form-control-sm" placeholder="New site name">
        <button id="create-site" class="btn btn-primary btn-sm"><i class="fas fa-plus"></i></button>
      </div>
    </div>

    <div id="sites-list" style="max-height:56vh; overflow:auto;"></div>

    <hr/>

    <div class="small text-muted mb-2">Backup / Restore</div>
    <div class="d-flex gap-2">
      <button id="export-json" class="btn btn-outline-secondary btn-sm"><i class="fas fa-file-export"></i> Export</button>
      <input id="import-file" type="file" accept="application/json" style="display:none">
      <button id="import-json" class="btn btn-outline-secondary btn-sm"><i class="fas fa-file-import"></i> Import</button>
      <button id="reset-all" class="btn btn-outline-danger btn-sm ms-auto" title="Clears all data">Reset</button>
    </div>
    <div class="muted small mt-2">Data stored locally in your browser's localStorage (key: <code>forms_manager_v1</code>).</div>
  </div>

  <!-- MIDDLE: Fields & Forms -->
  <div class="panel">
    <div class="d-flex align-items-center justify-content-between mb-3">
      <div>
        <h4 id="selected-site-title" class="m-0">Select or create a site</h4>
        <div id="selected-site-desc" class="muted small">Choose a site on the left to manage fields & forms</div>
      </div>
      <div>
        <button id="add-field-btn" class="btn btn-outline-primary btn-sm" disabled><i class="fas fa-folder-plus"></i> Add Field</button>
      </div>
    </div>

    <div id="field-creator" class="mb-3" style="display:none;">
      <div class="row g-2">
        <div class="col-md-5">
          <input id="field-title" class="form-control form-control-sm" placeholder="Field title (e.g. Attendance)">
        </div>
        <div class="col-md-5">
          <input id="field-desc" class="form-control form-control-sm" placeholder="Field description (optional)">
        </div>
        <div class="col-md-2 d-grid">
          <button id="create-field" class="btn btn-primary btn-sm">Create</button>
        </div>
      </div>
    </div>

    <div id="fields-area">
      <div class="empty">No field selected — create a field or choose a site.</div>
    </div>
  </div>

  <!-- RIGHT: Embed / Preview -->
  <div class="panel">
    <div class="d-flex align-items-center justify-content-between mb-2">
      <div>
        <h5 id="embed-title" class="m-0">Preview</h5>
        <div id="embed-sub" class="muted small">Select a form to preview here</div>
      </div>
      <div class="d-flex gap-2">
        <button id="open-original" class="btn btn-outline-secondary btn-sm" disabled><i class="fas fa-external-link-alt"></i> Open</button>
      </div>
    </div>

    <div class="d-flex gap-2 mb-2">
      <button id="show-form-btn" class="btn btn-primary btn-sm" disabled>Show Form</button>
      <button id="show-sheet-btn" class="btn btn-outline-secondary btn-sm" disabled>Show Sheet</button>
    </div>

    <div id="embed-area" class="iframe-wrap">
      <div id="embed-empty" class="empty">No form selected</div>
      <iframe id="embed-iframe" src="" style="width:100%;height:100%;border:0;display:none;"></iframe>
    </div>

    <div id="embed-note" class="muted small mt-2">Tip: For sheets to embed, publish the sheet to web or set "Anyone with the link" viewer. Forms usually embed if not restricted to a domain.</div>
  </div>
</div>

<!-- Modal: Add Form -->
<div class="modal fade" id="formModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Add / Edit Form</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="mb-2 small text-muted">Fill form details. Paste regular Google Form & Sheet links — converter will try to embed them automatically.</div>
        <div class="mb-2">
          <input id="form-name" class="form-control" placeholder="Form name (e.g. Attendance)">
        </div>
        <div class="mb-2">
          <input id="form-url" class="form-control" placeholder="Google Form URL (https://docs.google.com/forms/...)">
        </div>
        <div class="mb-2">
          <input id="sheet-url" class="form-control" placeholder="Google Sheet URL (optional) (https://docs.google.com/spreadsheets/...)">
        </div>
        <div class="mb-2">
          <input id="form-notes" class="form-control" placeholder="Notes (optional)">
        </div>
        <div id="form-modal-alert" class="mt-2 small text-danger" style="display:none;"></div>
      </div>
      <div class="modal-footer">
        <button id="save-form" type="button" class="btn btn-primary">Save form</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Bootstrap & icons -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.0/js/bootstrap.bundle.min.js"></script>

<script>
/* =======================
   Data model & persistence
   ======================= */

const STORAGE_KEY = 'forms_manager_v1';

const defaultData = {
  sites: [
    {
      id: genId('site'),
      name: 'Demo Site',
      description: 'Example site to show fields and forms',
      fields: [
        {
          id: genId('field'),
          title: 'Measurements',
          description: 'Measurement forms',
          forms: [
            {
              id: genId('form'),
              name: 'Building Measurement Form',
              formUrl: 'https://docs.google.com/forms/d/e/1FAIpQLSe-example-form-id/viewform',
              sheetUrl: '',
              notes: ''
            }
          ]
        },
        {
          id: genId('field'),
          title: 'Surveys',
          description: 'Customer surveys',
          forms: [
            {
              id: genId('form'),
              name: 'Customer Satisfaction Survey',
              formUrl: 'https://docs.google.com/forms/d/e/1FAIpQLSe-other-form-id/viewform',
              sheetUrl: 'https://docs.google.com/spreadsheets/d/1exampleSheetId/edit#gid=0',
              notes: ''
            }
          ]
        }
      ]
    }
  ]
};

let state = loadState();

/* helpers */
function saveState() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
}
function loadState() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultData));
      return JSON.parse(JSON.stringify(defaultData));
    }
    return JSON.parse(raw);
  } catch(e) {
    console.error('Failed to load state', e);
    localStorage.removeItem(STORAGE_KEY);
    localStorage.setItem(STORAGE_KEY, JSON.stringify(defaultData));
    return JSON.parse(JSON.stringify(defaultData));
  }
}
function genId(prefix='id'){ return prefix + '_' + Math.random().toString(36).slice(2,9); }

/* =======================
   DOM references
   ======================= */

const sitesListEl = document.getElementById('sites-list');
const newSiteNameEl = document.getElementById('new-site-name');
const createSiteBtn = document.getElementById('create-site');
const selectedSiteTitle = document.getElementById('selected-site-title');
const selectedSiteDesc = document.getElementById('selected-site-desc');
const addFieldBtn = document.getElementById('add-field-btn');
const fieldCreatorEl = document.getElementById('field-creator');
const createFieldBtn = document.getElementById('create-field');
const fieldTitleEl = document.getElementById('field-title');
const fieldDescEl = document.getElementById('field-desc');
const fieldsArea = document.getElementById('fields-area');

const embedTitle = document.getElementById('embed-title');
const embedSub = document.getElementById('embed-sub');
const embedIframe = document.getElementById('embed-iframe');
const embedEmpty = document.getElementById('embed-empty');
const embedArea = document.getElementById('embed-area');
const openOriginalBtn = document.getElementById('open-original');
const showFormBtn = document.getElementById('show-form-btn');
const showSheetBtn = document.getElementById('show-sheet-btn');

const exportBtn = document.getElementById('export-json');
const importBtn = document.getElementById('import-json');
const importFileInput = document.getElementById('import-file');
const resetBtn = document.getElementById('reset-all');

/* modal elements */
const formModal = new bootstrap.Modal(document.getElementById('formModal'), {backdrop:'static'});
const formNameEl = document.getElementById('form-name');
const formUrlEl = document.getElementById('form-url');
const sheetUrlEl = document.getElementById('sheet-url');
const formNotesEl = document.getElementById('form-notes');
const saveFormBtn = document.getElementById('save-form');
const formModalAlert = document.getElementById('form-modal-alert');

let selectedSiteId = null;
let editingFieldId = null;
let editingFormId = null;
let previewState = { type:null, url:null, originalUrl:null };

/* =======================
   UI rendering
   ======================= */

function renderSites() {
  sitesListEl.innerHTML = '';
  state.sites.forEach(site => {
    const div = document.createElement('div');
    div.className = 'd-flex align-items-start justify-content-between mb-2';
    div.innerHTML = `
      <div style="flex:1">
        <div class="site-item" data-id="${site.id}" title="${escapeHtml(site.description||'')}">
          <div class="d-flex justify-content-between align-items-center">
            <div><strong>${escapeHtml(site.name)}</strong><div class="small muted">${escapeHtml(site.description||'')}</div></div>
          </div>
        </div>
      </div>
      <div class="ms-2 d-flex flex-column gap-1">
        <button class="btn btn-sm btn-outline-secondary edit-site" data-id="${site.id}" title="Edit site"><i class="fas fa-pen"></i></button>
        <button class="btn btn-sm btn-outline-danger del-site" data-id="${site.id}" title="Delete site"><i class="fas fa-trash"></i></button>
      </div>
    `;
    sitesListEl.appendChild(div);
  });

  // events
  document.querySelectorAll('.site-item').forEach(el => {
    el.onclick = () => {
      const id = el.getAttribute('data-id');
      selectSite(id);
    };
  });
  document.querySelectorAll('.edit-site').forEach(btn => {
    btn.onclick = (e) => {
      e.stopPropagation();
      const id = btn.getAttribute('data-id');
      editSite(id);
    };
  });
  document.querySelectorAll('.del-site').forEach(btn => {
    btn.onclick = (e) => {
      e.stopPropagation();
      const id = btn.getAttribute('data-id');
      if (!confirm('Delete site and all its fields/forms?')) return;
      deleteSite(id);
    };
  });
}

function selectSite(id) {
  selectedSiteId = id;
  const site = state.sites.find(s=>s.id===id);
  if (!site) return;
  selectedSiteTitle.textContent = site.name;
  selectedSiteDesc.textContent = site.description || '';
  addFieldBtn.disabled = false;
  fieldCreatorEl.style.display = '';
  renderFields(site);
  // set active class on left
  document.querySelectorAll('.site-item').forEach(el => el.classList.toggle('active', el.getAttribute('data-id')===id));
}

function renderFields(site) {
  fieldsArea.innerHTML = '';
  if (!site.fields || site.fields.length === 0) {
    fieldsArea.innerHTML = `<div class="empty">No fields yet. Click "Add Field" to create one.</div>`;
    return;
  }
  const frag = document.createDocumentFragment();
  site.fields.forEach(field => {
    const card = document.createElement('div');
    card.className = 'mb-3';
    card.innerHTML = `
      <div class="field-card">
        <div class="d-flex justify-content-between align-items-start">
          <div>
            <h5 style="margin:0">${escapeHtml(field.title)}</h5>
            <div class="muted small">${escapeHtml(field.description || '')}</div>
          </div>
          <div class="d-flex gap-2">
            <button class="btn btn-sm btn-outline-secondary edit-field" data-field="${field.id}"><i class="fas fa-pen"></i></button>
            <button class="btn btn-sm btn-outline-primary add-form" data-field="${field.id}"><i class="fas fa-plus"></i> Form</button>
            <button class="btn btn-sm btn-outline-danger del-field" data-field="${field.id}"><i class="fas fa-trash"></i></button>
          </div>
        </div>
        <div class="mt-3">
          ${ renderFormsList(field.forms || []) }
        </div>
      </div>
    `;
    frag.appendChild(card);
  });
  fieldsArea.appendChild(frag);

  // attach events
  document.querySelectorAll('.add-form').forEach(b => {
    b.onclick = (e) => {
      const fieldId = b.getAttribute('data-field');
      openFormModal(null, fieldId);
    };
  });
  document.querySelectorAll('.edit-field').forEach(b => {
    b.onclick = (e) => {
      const fid = b.getAttribute('data-field');
      editField(fid);
    };
  });
  document.querySelectorAll('.del-field').forEach(b => {
    b.onclick = (e) => {
      if (!confirm('Delete this field and its forms?')) return;
      const fid = b.getAttribute('data-field');
      deleteField(fid);
    };
  });
  document.querySelectorAll('.btn-open-form').forEach(b => {
    b.onclick = (e) => {
      const fid = b.getAttribute('data-field');
      const formId = b.getAttribute('data-form');
      openFormPreview(fid, formId);
    };
  });
  document.querySelectorAll('.btn-edit-form').forEach(b => {
    b.onclick = (e) => {
      const fid = b.getAttribute('data-field');
      const formId = b.getAttribute('data-form');
      openFormModal({fieldId:fid, formId});
    };
  });
  document.querySelectorAll('.btn-del-form').forEach(b => {
    b.onclick = (e) => {
      const fid = b.getAttribute('data-field');
      const formId = b.getAttribute('data-form');
      if (!confirm('Delete this form?')) return;
      deleteForm(fid, formId);
    };
  });
}

function renderFormsList(forms) {
  if (!forms || forms.length === 0) return `<div class="empty">No forms in this field</div>`;
  return forms.map(f => `
    <div class="form-row">
      <div>
        <strong>${escapeHtml(f.name)}</strong>
        <div class="small muted">${escapeHtml(f.formUrl || '')}</div>
      </div>
      <div class="d-flex gap-1">
        <button class="btn btn-sm btn-primary btn-open-form" data-field="${escapeHtmlAttribute(f.fieldId||'')}" data-form="${f.id}"><i class="fas fa-eye"></i> View</button>
        <button class="btn btn-sm btn-outline-secondary btn-edit-form" data-field="${escapeHtmlAttribute(f.fieldId||'')}" data-form="${f.id}"><i class="fas fa-pen"></i></button>
        <button class="btn btn-sm btn-outline-danger btn-del-form" data-field="${escapeHtmlAttribute(f.fieldId||'')}" data-form="${f.id}"><i class="fas fa-trash"></i></button>
      </div>
    </div>
  `).join('');
}

/* =======================
   CRUD operations
   ======================= */

createSiteBtn.onclick = () => {
  const name = newSiteNameEl.value.trim();
  if (!name) return alert('Enter site name');
  const site = { id: genId('site'), name, description:'', fields:[] };
  state.sites.unshift(site);
  saveState();
  newSiteNameEl.value = '';
  renderSites();
  selectSite(site.id);
};

function editSite(id) {
  const site = state.sites.find(s=>s.id===id);
  if (!site) return;
  const newName = prompt('Site name', site.name);
  if (newName === null) return;
  const newDesc = prompt('Site description', site.description || '') ?? '';
  site.name = newName.trim() || site.name;
  site.description = newDesc.trim();
  saveState();
  renderSites();
  if (selectedSiteId === id) selectSite(id);
}

function deleteSite(id) {
  const idx = state.sites.findIndex(s=>s.id===id);
  if (idx === -1) return;
  state.sites.splice(idx,1);
  saveState();
  renderSites();
  // if deleted selected site, clear UI
  if (selectedSiteId === id) {
    selectedSiteId = null;
    selectedSiteTitle.textContent = 'Select or create a site';
    selectedSiteDesc.textContent = 'Choose a site on the left to manage fields & forms';
    addFieldBtn.disabled = true;
    fieldCreatorEl.style.display = 'none';
    fieldsArea.innerHTML = `<div class="empty">No site selected</div>`;
  }
}

addFieldBtn.onclick = () => {
  fieldTitleEl.value = '';
  fieldDescEl.value = '';
  editingFieldId = null;
  fieldCreatorEl.style.display = '';
  fieldTitleEl.focus();
};

createFieldBtn.onclick = () => {
  const title = fieldTitleEl.value.trim();
  if (!title) return alert('Enter field title');
  const desc = fieldDescEl.value.trim();
  const site = state.sites.find(s=>s.id===selectedSiteId);
  if (!site) return alert('No site selected');
  const field = { id: genId('field'), title, description:desc, forms:[] };
  site.fields.unshift(field);
  saveState();
  renderFields(site);
  fieldTitleEl.value = fieldDescEl.value = '';
};

function editField(fieldId) {
  const site = state.sites.find(s=>s.id===selectedSiteId);
  if (!site) return;
  const field = site.fields.find(f=>f.id===fieldId);
  if (!field) return;
  const newTitle = prompt('Field title', field.title);
  if (newTitle === null) return;
  const newDesc = prompt('Field description', field.description || '') ?? '';
  field.title = newTitle.trim() || field.title;
  field.description = newDesc.trim();
  saveState();
  renderFields(site);
}

function deleteField(fieldId) {
  const site = state.sites.find(s=>s.id===selectedSiteId);
  if (!site) return;
  const idx = site.fields.findIndex(f=>f.id===fieldId);
  if (idx === -1) return;
  site.fields.splice(idx,1);
  saveState();
  renderFields(site);
}

/* Forms CRUD + modal flow */
function openFormModal({fieldId=null, formId=null} = {}) {
  if (!selectedSiteId) return alert('Select site first');
  editingFieldId = fieldId;
  editingFormId = formId || null;
  formModalAlert.style.display = 'none';
  if (formId) {
    // editing existing
    const site = state.sites.find(s=>s.id===selectedSiteId);
    const field = site.fields.find(ff=>ff.id===fieldId);
    const form = field.forms.find(f=>f.id===formId);
    formNameEl.value = form.name || '';
    formUrlEl.value = form.formUrl || '';
    sheetUrlEl.value = form.sheetUrl || '';
    formNotesEl.value = form.notes || '';
  } else {
    // new
    formNameEl.value = '';
    formUrlEl.value = '';
    sheetUrlEl.value = '';
    formNotesEl.value = '';
  }
  formModal.show();
}

saveFormBtn.onclick = () => {
  const name = formNameEl.value.trim();
  const formUrl = formUrlEl.value.trim();
  const sheetUrl = sheetUrlEl.value.trim();
  if (!name || !formUrl) {
    formModalAlert.style.display = 'block';
    formModalAlert.textContent = 'Form name and Form URL are required.';
    return;
  }
  const site = state.sites.find(s=>s.id===selectedSiteId);
  const field = site.fields.find(ff=>ff.id===editingFieldId);
  if (!field) {
    alert('Field missing; refresh the page.');
    formModal.hide();
    return;
  }
  if (editingFormId) {
    // update
    const form = field.forms.find(f=>f.id===editingFormId);
    form.name = name;
    form.formUrl = formUrl;
    form.sheetUrl = sheetUrl;
    form.notes = formNotesEl.value.trim();
  } else {
    const newForm = { id: genId('form'), name, formUrl, sheetUrl, notes: formNotesEl.value.trim() };
    field.forms.unshift(newForm);
  }
  saveState();
  renderFields(site);
  formModal.hide();
};

/* Delete form */
function deleteForm(fieldId, formId) {
  const site = state.sites.find(s=>s.id===selectedSiteId);
  if (!site) return;
  const field = site.fields.find(f=>f.id===fieldId);
  if (!field) return;
  const idx = field.forms.findIndex(ff=>ff.id===formId);
  if (idx === -1) return;
  field.forms.splice(idx,1);
  saveState();
  renderFields(site);
}

/* Preview / Embed */
function openFormPreview(fieldId, formId) {
  const site = state.sites.find(s=>s.id===selectedSiteId);
  const field = site.fields.find(f=>f.id===fieldId);
  const form = field.forms.find(x=>x.id===formId);
  if (!form) return;
  // set preview
  embedTitle.textContent = form.name;
  embedSub.textContent = form.notes || form.formUrl || '';
  openOriginalBtn.disabled = false;
  showFormBtn.disabled = false;
  showSheetBtn.disabled = false;
  openOriginalBtn.onclick = () => window.open(form.formUrl || form.sheetUrl || '#','_blank');

  // store preview state
  previewState = {
    type: 'form',
    form,
    url: null,
    originalUrl: form.formUrl
  };
  // default show form
  showFormPreview(form);
}

/* conversion functions (tries to create embeddable URL) */
function toFormEmbedUrl(url) {
  if (!url) return null;
  // already embedded param
  if (url.includes('embedded=true')) return url;
  // pattern: forms/d/e/<id>
  const m = url.match(/forms\/d\/e\/([^\/?#]+)/);
  if (m && m[1]) return `https://docs.google.com/forms/d/e/${m[1]}/viewform?embedded=true`;
  if (url.includes('/viewform')) {
    return url.indexOf('?') === -1 ? url + '?embedded=true' : url + '&embedded=true';
  }
  // sometimes forms are /d/<id>/viewform (rare)
  const m2 = url.match(/forms\/d\/([^\/?#]+)/);
  if (m2 && m2[1]) return `https://docs.google.com/forms/d/${m2[1]}/viewform?embedded=true`;
  return url;
}
function toSheetEmbedUrl(url) {
  if (!url) return null;
  if (url.includes('/pubhtml')) return url;
  const m = url.match(/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
  if (m && m[1]) return `https://docs.google.com/spreadsheets/d/${m[1]}/pubhtml?widget=true&headers=false`;
  return url;
}

function showFormPreview(form) {
  const embed = toFormEmbedUrl(form.formUrl);
  previewState.url = embed;
  // attempt to embed
  embedIframe.style.display = 'block';
  embedIframe.src = embed;
  embedEmpty.style.display = 'none';
  // handle load errors via onload + small timeout; some embed may require auth and show sign-in instead
  embedIframe.onload = () => {
    // show iframe (already visible). Clear any notes.
  };
  // fallback message if embed fails: we can't perfectly detect CORS/permission failures; user will see Google sign-in in frame or blank.
}

function showSheetPreview(form) {
  if (!form.sheetUrl) {
    embedIframe.style.display = 'none';
    embedEmpty.style.display = 'block';
    embedEmpty.textContent = 'No Google Sheet URL provided for this form.';
    return;
  }
  const embed = toSheetEmbedUrl(form.sheetUrl);
  previewState.url = embed;
  embedIframe.style.display = 'block';
  embedIframe.src = embed;
  embedEmpty.style.display = 'none';
  embedIframe.onload = () => {};
}

/* buttons */
showFormBtn.onclick = () => {
  if (!previewState.form) return;
  showFormPreview(previewState.form);
};
showSheetBtn.onclick = () => {
  if (!previewState.form) return;
  showSheetPreview(previewState.form);
};

/* =======================
   Export / Import / Reset
   ======================= */

exportBtn.onclick = () => {
  const data = JSON.stringify(state, null, 2);
  const blob = new Blob([data], {type:'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'forms_manager_export.json';
  a.click();
  URL.revokeObjectURL(url);
};

importBtn.onclick = () => importFileInput.click();
importFileInput.onchange = async (e) => {
  const f = e.target.files[0];
  if (!f) return;
  const txt = await f.text();
  try {
    const parsed = JSON.parse(txt);
    if (!parsed.sites) throw new Error('Invalid file');
    if (!confirm('Import will overwrite current local data. Proceed?')) return;
    state = parsed;
    saveState();
    renderSites();
    if (state.sites.length) selectSite(state.sites[0].id);
    importFileInput.value = '';
  } catch(err) {
    alert('Invalid JSON file: ' + err.message);
  }
};

resetBtn.onclick = () => {
  if (!confirm('Reset local data? This will clear all sites/fields/forms.')) return;
  localStorage.removeItem(STORAGE_KEY);
  state = loadState();
  renderSites();
  if (state.sites.length) selectSite(state.sites[0].id);
};

/* =======================
   Utility / startup
   ======================= */

function escapeHtml(s){ if(!s) return ''; return String(s).replace(/[&<>"']/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[c]); }
function escapeHtmlAttribute(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

function init() {
  renderSites();
  // auto-select first site if any
  if (state.sites.length) selectSite(state.sites[0].id);
}
init();

/* =======================
   Small enhancement: when rendering forms list, we included data-field attributes but not the fieldId into form objects.
   For open/edit/delete handlers that use data-field, we need to ensure forms carry no fieldId — we pass fieldId from button attributes.
   ======================= */

/* End of script */
</script>
</body>
</html>
